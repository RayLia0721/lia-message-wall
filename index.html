import { serverTimestamp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

window.submitComment = async function submitComment() {
  const username = document.getElementById('username').value.trim();
  const comment = document.getElementById('comment').value.trim();
  const avatarInput = document.getElementById('avatarUpload');
  const photoInput = document.getElementById('photoUpload');

  if (!username || !comment) {
    alert("請輸入姓名與留言");
    return;
  }

  const now = new Date();
  const timestamp = now.toLocaleString('zh-TW', {
    timeZone: 'Asia/Taipei',
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit'
  });

  const defaultAvatar = 'https://lh3.googleusercontent.com/pw/AP1GczNlQafm937bNM3sCxJih4IXLTyo1x3Ea7qjJrgfK6v6iVTLwXU3RGMG0npHLkJPJBM1sF9VDIlsqPK-fQwPcvzJNqW4nzv6SWjcqV-nKRVn5FN1B8G7fCGwwSKXaxKAFwt1AN1kneMMJTfEz8yY_OU=w739-h739-s-no-gm?authuser=0';

  const readerPromises = [];

  if (avatarInput.files && avatarInput.files[0]) {
    const avatarReader = new FileReader();
    readerPromises.push(new Promise(resolve => {
      avatarReader.onload = e => resolve({ avatarSrc: e.target.result });
      avatarReader.readAsDataURL(avatarInput.files[0]);
    }));
  } else {
    readerPromises.push(Promise.resolve({ avatarSrc: defaultAvatar }));
  }

  if (photoInput.files && photoInput.files[0]) {
    const photoReader = new FileReader();
    readerPromises.push(new Promise(resolve => {
      photoReader.onload = e => resolve({ photoSrc: e.target.result });
      photoReader.readAsDataURL(photoInput.files[0]);
    }));
  } else {
    readerPromises.push(Promise.resolve({ photoSrc: null }));
  }

  const results = await Promise.all(readerPromises);
  const avatarSrc = results[0].avatarSrc;
  const photoSrc = results[1].photoSrc;

  await addDoc(messagesRef, {
    username,
    comment,
    avatarSrc,
    photoSrc,
    timestamp,
    country: userCountry,
    time: serverTimestamp() // ✅ 使用 Firebase 伺服器時間
  });

  // 不再立即顯示浮動訊息，讓 onSnapshot 統一處理顯示
  document.getElementById('notification-sound')?.play();

  // 清空輸入欄位
  document.getElementById('username').value = '';
  document.getElementById('comment').value = '';
  document.getElementById('avatarUpload').value = '';
  document.getElementById('photoUpload').value = '';
};
