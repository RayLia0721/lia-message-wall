<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>Lia Birthday Message Wall</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    /* 原本 CSS 無變動，省略顯示 */
  </style>
</head>
<body>

<div id="floating-message-container"></div>

<div id="message-wall">
  <div id="message-count">目前留言數：0</div>
  <div id="message-list"></div>
</div>

<div id="input-box">
  <input type="text" id="username" placeholder="你的名字 Your name" />
  <textarea id="comment" rows="2" placeholder="輸入留言 Your message..."></textarea>

  <label for="avatarUpload" id="avatar-label">上傳頭像 Upload profile photo</label>
  <input type="file" id="avatarUpload" accept="image/*" />

  <label for="photoUpload" id="photo-label">上傳照片 Upload a photo</label>
  <input type="file" id="photoUpload" accept="image/*" />

  <button onclick="submitComment()">送出留言 Submit</button>
</div>

<audio id="bg-music" autoplay loop>
  <source src="https://www.dropbox.com/scl/fi/eiwttq7xrflz3clieoalm/ITZY-Promise.mp3?rlkey=souwjpr02pbksje2onfg69upr&raw=1" type="audio/mpeg" />
</audio>

<audio id="notification-sound">
  <source src="https://www.dropbox.com/scl/fi/jcejfp8pufq7iqkjemkmh/buyabu.MP3?rlkey=wdh3lmgbswbdlblvv5ai6sfc8&raw=1" />
</audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    onSnapshot,
    deleteDoc,
    doc,
    getDocs,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCKNZ635pFVVf_V1dUL1XRq4GNa07YeeqE",
    authDomain: "lia-message-board.firebaseapp.com",
    databaseURL: "https://lia-message-board-default-rtdb.firebaseio.com",
    projectId: "lia-message-board",
    storageBucket: "lia-message-board.appspot.com",
    messagingSenderId: "665551485788",
    appId: "1:665551485788:web:dc99c381d55756c2571f99"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const messagesRef = collection(db, "messages");

  let userCountry = 'Unknown';
  fetch('https://api.country.is/')
    .then(res => res.json())
    .then(data => userCountry = (data.country === 'TW') ? 'Taiwan' : data.country)
    .catch(() => {});

  onSnapshot(messagesRef, snapshot => {
    const messages = [];
    const existingIds = new Set();
    document.querySelectorAll('.floating-message').forEach(div => {
      existingIds.add(div.dataset.id);
    });

    snapshot.forEach(doc => {
      const data = { ...doc.data(), id: doc.id };
      messages.push(data);
      if (!existingIds.has(data.id)) {
        showFloatingMessage(data.username, data.comment, data.avatarSrc, data.id);
      }
    });

    messages.sort((a, b) => {
      const timeA = a.time?.seconds || 0;
      const timeB = b.time?.seconds || 0;
      return timeA - timeB;
    });

    renderMessages(messages);
  });

  window.submitComment = async function () {
    const username = document.getElementById('username').value.trim();
    const comment = document.getElementById('comment').value.trim();
    const avatarInput = document.getElementById('avatarUpload');
    const photoInput = document.getElementById('photoUpload');

    if (!username || !comment) {
      alert("請輸入姓名與留言");
      return;
    }

    const now = new Date();
    const timestamp = now.toLocaleString('zh-TW', {
      timeZone: 'Asia/Taipei',
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    });

    const defaultAvatar = 'https://lh3.googleusercontent.com/pw/AP1GczNlQafm937bNM3sCxJih4IXLTyo1x3Ea7qjJrgfK6v6iVTLwXU3RGMG0npHLkJPJBM1sF9VDIlsqPK-fQwPcvzJNqW4nzv6SWjcqV-nKRVn5FN1B8G7fCGwwSKXaxKAFwt1AN1kneMMJTfEz8yY_OU=w739-h739-s-no-gm?authuser=0';

    const readerPromises = [];

    if (avatarInput.files[0]) {
      const avatarReader = new FileReader();
      readerPromises.push(new Promise(resolve => {
        avatarReader.onload = e => resolve({ avatarSrc: e.target.result });
        avatarReader.readAsDataURL(avatarInput.files[0]);
      }));
    } else {
      readerPromises.push(Promise.resolve({ avatarSrc: defaultAvatar }));
    }

    if (photoInput.files[0]) {
      const photoReader = new FileReader();
      readerPromises.push(new Promise(resolve => {
        photoReader.onload = e => resolve({ photoSrc: e.target.result });
        photoReader.readAsDataURL(photoInput.files[0]);
      }));
    } else {
      readerPromises.push(Promise.resolve({ photoSrc: null }));
    }

    const results = await Promise.all(readerPromises);
    const avatarSrc = results[0].avatarSrc;
    const photoSrc = results[1].photoSrc;

    await addDoc(messagesRef, {
      username, comment, avatarSrc, photoSrc,
      timestamp, country: userCountry,
      time: serverTimestamp()
    });

    document.getElementById('notification-sound').play();
    document.getElementById('username').value = '';
    document.getElementById('comment').value = '';
    document.getElementById('avatarUpload').value = '';
    document.getElementById('photoUpload').value = '';
  };

  window.renderMessages = function (messages) {
    const list = document.getElementById('message-list');
    const count = document.getElementById('message-count');
    list.innerHTML = '';
    count.innerText = `目前留言數：${messages.length}`;
    for (const msg of messages) {
      const commentDiv = document.createElement('div');
      commentDiv.className = 'message';
      commentDiv.innerHTML = `
        <button class="delete-btn" onclick="deleteMessage('${msg.id}')">刪除</button>
        <div><img src="${msg.avatarSrc}" class="avatar" /><strong>${msg.username}</strong></div>
        <div>${msg.comment}</div>
        ${msg.photoSrc ? `<img src="${msg.photoSrc}" class="uploaded-photo" />` : ''}
        <div class="meta">${msg.timestamp} ${msg.country || ''}</div>
      `;
      list.appendChild(commentDiv);
    }
    document.getElementById('message-wall').scrollTop = list.scrollHeight;
  };

  window.showFloatingMessage = function (username, comment, avatarSrc, id) {
    const container = document.getElementById('floating-message-container');
    const msg = document.createElement('div');
    msg.className = 'floating-message';
    msg.dataset.id = id;
    msg.innerHTML = `<div><img src="${avatarSrc}" /><strong>${username}</strong></div><div>${comment}</div>`;
    container.appendChild(msg);
    moveMessageRandomly(msg, container);
  };

  window.moveMessageRandomly = function (msg, container) {
    const move = () => {
      const maxX = container.clientWidth - msg.offsetWidth;
      const maxY = container.clientHeight - msg.offsetHeight;
      const randomX = Math.random() * maxX;
      const randomY = Math.random() * maxY;
      msg.style.transform = `translate(${randomX}px, ${randomY}px)`;
    };
    move();
    setInterval(move, 10000);
  };

  window.deleteMessage = async function (id) {
    await deleteDoc(doc(db, "messages", id));
  };
</script>

</body>
</html>
